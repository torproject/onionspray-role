---
#
# Onionspray Ansible role test playbook
#
# Copyright (C) 2024 The Tor Project, Inc.
# SPDX-License-Identifier: AGPL-3.0-or-later
#

- name: Converge
  hosts: all

  # Ensure Ansible become root when running on localhost
  become: true
  become_method: community.general.sudosu

  # Gathering facts requires a container with Python installed
  gather_facts: true

  vars:
    onionspray_project_settings:
      - project_name: "example1"
        softmaps:
          - proxied_domain: example.com
          - proxied_domain: example.org
      - project_name: "example2"
        hardmaps:
          - tor_address: yetkvkuqlr23sdzkf2mynt7aixfjzq6pjys2ffurr3hzpyfxrc7swpqd
            proxied_domain: example.net
        project_custom_settings: |
          # two reasons to use a local resolver
          # - performance
          # - being able to hardcode IPs for a given DNS name
          set nginx_resolver 127.0.0.1 ipv6=off

          # block access to "forbidden" subdomain
          set block_err This subdomain is forbidden.
          set block_host_re ^forbidden\.

          ## rate-limiting
          ## c.f. https://onionservices.torproject.org/apps/web/onionspray/guides/dos/
          # max number of connections through this proxy
          set tor_max_streams 1000
          # setting these two options expose a header named "X-Onion-CircuitID" with a unique ID per Tor user
          # that header can be used for rate-limiting
          set tor_export_circuit_id haproxy
          set nginx_x_onion_circuit_id 1

    onionspray_keys:
      # Bogus data for testing purposes
      - public_key_base64: Ym9ndXMgZGF0YSBmb3IgdGVzdGluZyBwdXJwb3Nlcwo=
        secret_key_base64: Ym9ndXMgZGF0YSBmb3IgdGVzdGluZyBwdXJwb3Nlcwo=
        tor_address: yetkvkuqlr23sdzkf2mynt7aixfjzq6pjys2ffurr3hzpyfxrc7swpqd


  pre_tasks:
    # Install the ACL package
    # https://stackoverflow.com/questions/46352173/ansible-failed-to-set-permissions-on-the-temporary#56379678
    - name: Install acl
      ansible.builtin.package:
        name: acl

    # Sudo is needed by some Ansible modules, and may not be available in the
    # container instance
    - name: Install sudo
      ansible.builtin.package:
        name: sudo

    #- name: Create the admin group
    #  ansible.builtin.group:
    #    name: "admin"

    # Users in admin group should have passwordless sudo
    # This ensures the Onionspray build script runs
    #- name: Configure passwordless sudo for the admin group
    #  ansible.builtin.lineinfile:
    #    create : true
    #    owner  : "root"
    #    group  : "root"
    #    mode   : "0600"
    #    line   : "%admin ALL=(ALL) NOPASSWD : ALL"
    #    path   : /etc/sudoers.d/90-admin

  roles:
    - onionspray
