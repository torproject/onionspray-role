#
# Onionspray configuration file for project {{ onionspray_project.name }}
#
# Copyright (C) 2025 The Tor Project, Inc.
# SPDX-License-Identifier: AGPL-3.0-or-later
#
# Generated by Ansible:
# https://gitlab.torproject.org/tpo/onion-services/ansible/onionspray-role
#

#
# General
#

{% if onionspray_project.name is defined %}
set project {{ onionspray_project.name }}
{% endif %}

#
# Certificates
#

{% if onionspray_project.check_cert_with_ca_file | default(true) %}
set nginx_proxy_ssl_trusted_certificate {{ onionspray_project.ca_file | default('/etc/ssl/certs/ca-certificates.crt') }}
{% endif %}

#
# Proxy
#

{% if onionspray_project.x_from_onion_value is defined %}
set x_from_onion_value {{ onionspray_project.x_from_onion_value }}
{% endif %}

{%- if onionspray_project.inject_headers_upstream is defined %}
set inject_headers_upstream {{ onionspray_project.inject_headers_upstream }}
{% endif %}

{%- if onionspray_project.nginx_resolver is defined %}
set nginx_resolver {{ onionspray_project.nginx_resolver }}
{% endif %}

{%- if onionspray_project.nginx_tmpfile_size is defined %}
set nginx_tmpfile_size {{ onionspray_project.nginx_tmpfile_size }}
{% endif %}

{%- if onionspray_project.nginx_cache_seconds is defined %}
set nginx_cache_seconds {{ onionspray_project.nginx_cache_seconds }}
{% endif %}

{%- if onionspray_project.nginx_cache_size is defined %}
set nginx_cache_size {{ onionspray_project.nginx_cache_size }}
{% endif %}

{%- if onionspray_project.nginx_x_onion_circuit_id is defined %}
set nginx_x_onion_circuit_id {{ onionspray_project.nginx_x_onion_circuit_id }}
{% endif %}

#
# Logging
#

{% if onionspray_project.log_separate is defined %}
set log_separate {{ onionspray_project.log_separate }}
{% endif %}

#
# Tor
#

{% if onionspray_project.tor_export_circuit_id is defined %}
set tor_export_circuit_id {{ onionspray_project.tor_export_circuit_id }}
{% endif %}

{%- if onionspray_project.tor_intros_per_daemon is defined %}
set tor_intros_per_daemon {{ onionspray_project.tor_intros_per_daemon }}
{% endif %}

{%- if onionspray_project.tor_single_onion is defined %}
set tor_single_onion {{ onionspray_project.tor_single_onion }}
{% endif %}

{%- if onionspray_project.tor_pow_enabled is defined %}
set tor_pow_enabled {{ onionspray_project.tor_pow_enabled }}
{% endif %}

{%- if onionspray_project.tor_pow_queue_rate is defined %}
set tor_pow_queue_rate {{ onionspray_project.tor_pow_queue_rate }}
{% endif %}

{%- if onionspray_project.tor_pow_queue_burst is defined %}
set tor_pow_queue_burst {{ onionspray_project.tor_pow_queue_burst }}
{% endif %}

{%- if onionspray_project.tor_intro_dos_defense is defined %}
set tor_intro_dos_defense {{ onionspray_project.tor_intro_dos_defense }}
{% endif %}

{%- if onionspray_project.tor_intro_dos_burst_per_sec is defined %}
set tor_intro_dos_burst_per_sec {{ onionspray_project.tor_intro_dos_burst_per_sec }}
{% endif %}

{%- if onionspray_project.tor_intro_dos_rate_per_sec is defined %}
set tor_intro_dos_rate_per_sec {{ onionspray_project.tor_intro_dos_rate_per_sec }}
{% endif %}

{%- if onionspray_project.tor_max_streams is defined %}
set tor_max_streams {{ onionspray_project.tor_max_streams }}
{% endif %}

{%- if onionspray_project.tor_max_streams_close_circuit is defined %}
set tor_max_streams_close_circuit {{ onionspray_project.tor_max_streams_close_circuit }}
{% endif %}

#
# Foreign maps
#

{% for foreignmap in onionspray_project.foreignmaps | default([]) %}
foreignmap {{ foreignmap.onion_address | truncate(56, True, '') }} {{ foreignmap.upstream_address }}
{% endfor %}

#
# Hardmaps
#

{% for hardmap in onionspray_project.hardmaps | default([]) %}
hardmap {{ hardmap.onion_address | default('%NEW_V3_ONION%') | truncate(56, True, '') }} {{ hardmap.upstream_address }}
{% endfor %}

#
# Softmaps
#

{% for softmap in onionspray_project.softmaps | default([]) %}
softmap {{ softmap.onion_address | default('%NEW_V3_ONION%') | truncate(56, True, '') }} {{ softmap.upstream_address }}
{% endfor %}

#
# Other
#

{{ onionspray_project.custom_settings | default('') }}
