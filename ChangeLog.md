# Onionspray Ansible Role ChangeLog

## v3.0.0 - Unreleased

### Summary

* Major release with **BREAKING CHANGES**.

* Refactorization with new variable scheme, which might break existing
  configurations ([tpo/onion-services/ansible/onionspray-role!9][]).
  Please update your variables accordingly.

### Features

* General refactor with improved keys and certificates handling
  ([tpo/onion-services/ansible/onionspray-role!9][]):
    * The role now supports custom HTTPS certificates (such as the ones issued by
      Certificate Authorities) and uploading keys from external sources.

    * The self-signed certificate can now be customized through a configuration
      file ([tpo/onion-services/onionspray#72][]).

    * The build procedure was improved in accordance to Onionspray's
      compilation procedure split between "dependencies" and "build" stages
      ([tpo/onion-services/onionspray#62][]) and build info files
      ([tpo/onion-services/onionspray#73][]).

* Added new variables to configure Onionspray, alleviating the need to use
  `custom_settings` ([tpo/onion-services/ansible/onionspray-role!8][]).

* Support for cron as alternative to systemd
  ([tpo/onion-services/ansible/onionspray-role!11][]).

* Aperiodic restarts ([tpo/onion-services/ansible/onionspray-role!12][]).

* Log rotation ([tpo/onion-services/ansible/onionspray-role!13][]).

* Support for uploading logs into [S3][]-compatible object storage services
  ([tpo/onion-services/ansible/onionspray-role!14][]) using [aws-cli][]; a
  quick check procedure is also provided
  ([tpo/onion-services/ansible/onionspray-role!16][]).

* Updated documentation ([tpo/onion-services/ansible/onionspray-role!17][]).

[tpo/onion-services/ansible/onionspray-role!8]: tpo/onion-services/ansible/onionspray-role!8
[tpo/onion-services/ansible/onionspray-role!9]: https://gitlab.torproject.org/tpo/onion-services/ansible/onionspray-role/-/merge_requests/9
[tpo/onion-services/ansible/onionspray-role!11]: https://gitlab.torproject.org/tpo/onion-services/ansible/onionspray-role/-/merge_requests/11
[tpo/onion-services/ansible/onionspray-role!12]: https://gitlab.torproject.org/tpo/onion-services/ansible/onionspray-role/-/merge_requests/12
[tpo/onion-services/ansible/onionspray-role!13]: https://gitlab.torproject.org/tpo/onion-services/ansible/onionspray-role/-/merge_requests/13
[tpo/onion-services/ansible/onionspray-role!14]: https://gitlab.torproject.org/tpo/onion-services/ansible/onionspray-role/-/merge_requests/14
[tpo/onion-services/ansible/onionspray-role!16]: https://gitlab.torproject.org/tpo/onion-services/ansible/onionspray-role/-/merge_requests/16
[tpo/onion-services/ansible/onionspray-role!17]: https://gitlab.torproject.org/tpo/onion-services/ansible/onionspray-role/-/merge_requests/17
[tpo/onion-services/onionspray#62]: https://gitlab.torproject.org/tpo/onion-services/onionspray/-/issues/62
[tpo/onion-services/onionspray#72]: https://gitlab.torproject.org/tpo/onion-services/onionspray/-/issues/72
[tpo/onion-services/onionspray#73]: https://gitlab.torproject.org/tpo/onion-services/onionspray/-/issues/73
[S3]: https://en.wikipedia.org/wiki/Amazon_S3
[aws-cli]: https://aws.amazon.com/cli/

### Breaking changes

The configuration format has changed again, and operators wishing to upgrade
should update their configuration accordingly:

* Variables `onionspray_project_settings` and `onionspray_keys` are now
  unified into `onionspray_projects`.
* Variables `onionspray_ca_file` and `onionspray_check_cert_with_ca_file`
  were integrated into `onionspray_projects`, as per-project settings.
* Some variable names have been changed.

New new format is fully documented in the [defaults file][defaults/main.yml],
and an example is given below:

```yaml
# Stick with a specific Onionspray version
onionspray_repository_version: a0e43045fe135e1b3f5b96e075ed519e4359ab7f

# Uploading keys and certificates from external locations,
# such as a password manager
onionspray_provider: 'myprovider'
onionspray_key_uploader_script : '../scripts/upload-keys-to-onionspray-instances'
onionspray_cert_uploader_script: '../scripts/upload-certs-to-onionspray-instances'

onionspray_projects:
  - name: "example1"
    # Onion Service proxying using Onionspray's hardmap config
    hardmaps:
      # Onion Service mapping to example.null
      # A random Onion Service address is generated by Onionspray
      # HTTPS certificates are generated and self-signed by Onionspray
      - upstream_address: example.null

      # Onion Service mapping to example.tld
      # HTTPS certificates are generated and self-signed by Onionspray
      - onion_address: expeksycd6djb4bvyan7vpl7rqb6rfecz4kkluj66gw6fd6wopc2pxyd.onion
        upstream_address: example.tld
        public_key_base64: BASE64_ENCODED_ONION_SERVICE_PUBLIC_KEY
        secret_key_base64: BASE64_ENCODED_ONION_SERVICE_SECRET_KEY_ENCRYPTED_WITH_ANSIBLE_VAULT

      # Onion Service mapping to example.net
      # HTTPS certificates are copied from Ansible
      - onion_address: yetkvkuqlr23sdzkf2mynt7aixfjzq6pjys2ffurr3hzpyfxrc7swpqd
        upstream_address: example.net
        public_key_base64: BASE64_ENCODED_ONION_SERVICE_PUBLIC_KEY
        secret_key_base64: BASE64_ENCODED_ONION_SERVICE_SECRET_KEY_ENCRYPTED_WITH_ANSIBLE_VAULT
        tls_certificate: |
          TLS_CERTIFICATE
        tls_secret_key: |
          TLS_SECRET_KEY_ENCRYPTED_WITH_ANSIBLE_VAULT
        onion_address: yetkvkuqlr23sdzkf2mynt7aixfjzq6pjys2ffurr3hzpyfxrc7swpqd

      # Onion Service mapping to example.io
      # HTTPS certificates are uploaded using an external script
      - onion_address: exmp3cho5nxislcjefyovvsqd36g23ouofdjtiiypv4cs3ahhpyonxyd
        upstream_address: example.io
        certificate_upload: true

    # Log settings
    log_separate: '1'

    # Proxy settings (NGINX)
    x_from_onion_value           : '1'
    nginx_resolver               : '127.0.0.53 ipv6=off'
    nginx_cache_seconds          : '60'
    nginx_cache_size             : '64m'
    nginx_tmpfile_size           : '8m'
    tor_export_circuit_id        : 'haproxy'
    tor_intros_per_daemon        : '6'
    tor_single_onion             : '1'
    tor_pow_enabled              : '1'
    tor_max_streams              : '5000'
    tor_max_streams_close_circuit: '1'
    tor_intro_dos_defense        : '1'
    tor_intro_dos_burst_per_sec  : '20000'
    tor_intro_dos_rate_per_sec   : '20000'

    # Custom settings, passed as-is to the Onionspray project configuration
    custom_settings: |
      # block access to "forbidden" subdomain
      set block_err This subdomain is forbidden.
      set block_host_re ^forbidden\.

  - name: "example2"
    # Onion Service proxying using Onionspray's softmap config
    softmaps:
      # Onion Service mapping to example.org, using Onionbalance
      # A random Onion Service address is generated by Onionspray
      # Certificates are generated and self-signed by Onionspray
      - upstream_address: example.org

      # Onion Service mapping to example.com, using Onionbalance
      # Certificates are generated and self-signed by Onionspray
      - upstream_address: example.com
        onion_address: excomw23fzloy3lekgrayzsiina4lqztjka5bvgqqe35xbfgcfrmjpyd.onion

    # Foreignmaps: declaring onion-to-site mappings that exist outside of
    # this particular configuration file, eg: for some other sites.
    foreingmaps:
      - onion_address: exaymhwjhgdopeebkv5p3lmb5vu2mmvcc7krpgwx6ngf4uvob2whkcqd.onion
        upstream_address: example.info
```

## v2.0.0 - 2025-08-11

### Summary

* Major refactor with **BREAKING CHANGES**.

### Features

* This release adds support for multiple [Onionspray][] projects.
  Each project can have multiple `hardmaps` and `softmaps` endpoints
  ([tpo/onion-services/ansible/onionspray-role!5][]).

* The variable `onionspray_project_settings` now contains all values used to
  customize a project, and is a list of dict, so more than one project can
  exist in the same Onionspray deployment.

* The key handling is improved to also allow for more than one key defined. A
  new variable `onionspray_keys` is added for this.

* An additional check and additional variables for the CA certificate file used
  are added: these allow skipping the upstream TLS certificate check, and
  defining a custom path for the CA cert file to use, as well as a protection
  to warn the user if the CA certificate file used is not present (and abort).

* Split role tasks into separate "subsystems"
  ([tpo/onion-services/ansible/onionspray-role!1][]).

* Added Continuous Integration (CI) with [AnCIble][]
  ([zoug/onionspray-ansible-role!2][] and
  [7c2228be28593532f5dd1f3fefd2129578d65c5e][]).

* Added `onionspray_use_systemd` variable ([zoug/onionspray-ansible-role!4][]).

[AnCIble]: https://gitlab.torproject.org/tpo/onion-services/ansible/ancible/
[tpo/onion-services/ansible/onionspray-role!5]: https://gitlab.torproject.org/tpo/onion-services/ansible/onionspray-role/-/merge_requests/5
[tpo/onion-services/ansible/onionspray-role!1]: https://gitlab.torproject.org/tpo/onion-services/ansible/onionspray-role/-/merge_requests/1
[zoug/onionspray-ansible-role!2]: https://gitlab.torproject.org/zoug/onionspray-ansible-role/-/merge_requests/2
[zoug/onionspray-ansible-role!4]: https://gitlab.torproject.org/zoug/onionspray-ansible-role/-/merge_requests/4
[7c2228be28593532f5dd1f3fefd2129578d65c5e]: https://gitlab.torproject.org/tpo/onion-services/ansible/onionspray-role/-/commit/7c2228be28593532f5dd1f3fefd2129578d65c5e

### Breaking changes

The configuration format has changed, and operators wishing to upgrade should
update their configuration accordingly.

The biggest change is that now the role support many Onionspray projects
instead of a single one, so migrating a configuration from the previous to the
new format mostly involves moving some variables to
`onionspray_project_settings` and `onionspray_keys` dictionaries.

Example for the new format:

```yaml
# Onion Service settings
onionspray_project_settings:
  - project_name: example1
    hardmaps:
      - proxied_domain: example.org

  - project_name: example2
    project_custom_settings: |
      # block access to "forbidden" subdomain
      set block_err This subdomain is forbidden.
      set block_host_re ^forbidden\.

      ## rate-limiting
      ## c.f. https://onionservices.torproject.org/apps/web/onionspray/guides/dos/
      # max number of connections through this proxy
      set tor_max_streams 1000

      # setting these two options expose a header named "X-Onion-CircuitID" with a unique ID per Tor user
      # that header can be used for rate-limiting
      set tor_export_circuit_id haproxy
      set nginx_x_onion_circuit_id 1
    softmaps:
      - tor_address: yetkvkuqlr23sdzkf2mynt7aixfjzq6pjys2ffurr3hzpyfxrc7swpqd
        proxied_domain: wikipedia.org
      - proxied_domain: wikimedia.org

# Onion Service keys
onionspray_keys:
  - public_key_base64: REDACTED
    secret_key_base64: REDACTED
    tor_address: yetkvkuqlr23sdzkf2mynt7aixfjzq6pjys2ffurr3hzpyfxrc7swpqd

  - public_key_base64: REDACTED
    secret_key_base64: REDACTED
    tor_address: 2k7kfvpa53a4exfkluhg5y33jtvrq3cgsn53ali7cltdlg3iadh6j4id
```

## v1.0.0 - 2024-09-02

### Summary

* Initial version.

### Features

* Can manage a single [Onionspray][] project.

* Support for either using pre-generated .onion keys or generating a random
  pair during configuration.

* Keeps a build lockfile to avoid compiling Onionspray dependencies every
  time the playbook is applied.

* Allow for customizing the self-signed HTTPS certificate metadata.

[Onionspray]: https://onionservices.torproject.org/apps/web/onionspray/

### Configuration format

The full configuration format for this release is available [here][docs-1.0], and
an example is given below:

[docs-1.0]: https://gitlab.torproject.org/tpo/onion-services/ansible/onionspray-role/-/tree/1.0?ref_type=tags

```yaml
# Onionspray repository revision to use
onionspray_repo_git_revision: a0e43045fe135e1b3f5b96e075ed519e4359ab7f

# Custom settings
onionspray_project_custom_settings: |
  # two reasons to use a local resolver
  # - performance
  # - being able to hardcode IPs for a given DNS name
  set nginx_resolver 127.0.0.1 ipv6=off

  # block access to "forbidden" subdomain
  set block_err This subdomain is forbidden.
  set block_host_re ^forbidden\.

  ## rate-limiting
  ## c.f. https://community.torproject.org/onion-services/ecosystem/apps/web/onionspray/guides/dos/
  # max number of connections through this proxy
  set tor_max_streams 1000
  # setting these two options expose a header named "X-Onion-CircuitID" with a unique ID per Tor user
  # that header can be used for rate-limiting
  set tor_export_circuit_id haproxy
  set nginx_x_onion_circuit_id 1
onionspray_proxied_domain: "example.com"
```
