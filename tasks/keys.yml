---
#
# Key handling
#
# Copyright (C) 2024 The Tor Project, Inc.
# SPDX-License-Identifier: AGPL-3.0-or-later
#

- name: keys | Create secrets directory
  ansible.builtin.file:
    path: "{{ onionspray_repo_download_path }}/secrets/"
    state: directory
    owner: "{{ onionspray_user }}"
    group: "{{ onionspray_user }}"
    mode: "700"

- name: keys | Copy Onion v3 public key(s)
  ansible.builtin.copy:
    content: "{{ settings.public_key_base64 | b64decode }}"
    dest: "{{ onionspray_repo_download_path }}/secrets/{{ settings.tor_address }}.v3pub.key"
    owner: "{{ onionspray_user }}"
    group: "{{ onionspray_user }}"
    mode: "600"
  no_log: true
  loop: "{{ onionspray_keys }}"
  when:
    - settings.public_key_base64 is defined
    - settings.secret_key_base64 is defined
    - settings.tor_address is defined

- name: keys | Copy Onion v3 secret key(s)
  ansible.builtin.copy:
    content: "{{ settings.secret_key_base64 | b64decode }}"
    dest: "{{ onionspray_repo_download_path }}/secrets/{{ settings.tor_address }}.v3sec.key"
    owner: "{{ onionspray_user }}"
    group: "{{ onionspray_user }}"
    mode: "600"
  no_log: true
  loop: "{{ onionspray_keys }}"
  when:
    - settings.public_key_base64 is defined
    - settings.secret_key_base64 is defined
    - settings.tor_address is defined
