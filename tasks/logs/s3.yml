---
#
# S3 log configuration
#
# Copyright (C) 2025 The Tor Project, Inc.
# SPDX-License-Identifier: AGPL-3.0-or-later
#

- name: logs | s3 | Install aws-cli and dependencies
  block:
    - name: logs | s3 | Install aws-cli from the distribution package
      ansible.builtin.package:
        name: 'awscli'
      when:
        - not onionspray_aws_cli_from_snap

    # Needed in order to install aws-cli
    # https://docs.aws.amazon.com/cli/latest/userguide/getting-started-install.html
    - name: logs | s3 | Install snapd
      ansible.builtin.package:
        name: snapd
      when:
        - onionspray_aws_cli_from_snap

    # Run snap directly
    #
    # The alternative would be using community.general.snap
    # https://docs.ansible.com/ansible/latest/collections/community/general/snap_module.html
    #
    # Snaps are automatically updated:
    #
    #   https://snapcraft.io/docs/managing-updates
    #   https://snapcraft.io/blog/how-to-manage-snap-updates
    #
    - name: logs | s3 | Install aws-cli from the snap package
      ansible.builtin.command:
        cmd     : "snap install aws-cli --classic"
        creates : "/snap/bin/aws"
      become      : true
      when:
        - onionspray_aws_cli_from_snap
